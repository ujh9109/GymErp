<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="SalesAnalyticsDao">

    <!-- =======================================================
         [START] 전체 매출 그래프 (서비스 + 실물 상품)
    ======================================================== -->
    <select id="selectTotalSalesChart" parameterType="map" resultType="map">
	    SELECT 
		    group_label,
		    category AS label,
		    SUM(total_sales) AS total_sales
	    FROM (
	        <!-- ✅ 서비스 매출 -->
	        SELECT 
	            CASE 
	                WHEN #{groupUnit} = 'DAY' THEN TO_CHAR(createdat, 'YYYY-MM-DD')
	                WHEN #{groupUnit} = 'WEEK' THEN TO_CHAR(createdat, 'IYYY-IW')
	                WHEN #{groupUnit} = 'MONTH' THEN TO_CHAR(createdat, 'YYYY-MM')
	                ELSE TO_CHAR(createdat, 'YYYY')
	            END AS group_label,
	            NVL(UPPER(servicetype), '기타') AS category,
	            actualamount AS total_sales
	        FROM sales_service
	        WHERE status = 'ACTIVE'
	        <if test="categories != null and categories.size() > 0">
	            AND UPPER(servicetype) IN (
	                <foreach collection="categories" item="cat" separator=",">
	                    UPPER(#{cat})
	                </foreach>
	            )
	        </if>
	        <if test="startDate != null and endDate != null">
	            AND createdat BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
	                              AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
	        </if>
	
	        UNION ALL
	
	        <!-- ✅ 실물 상품 매출 -->
	        SELECT 
	            CASE 
	                WHEN #{groupUnit} = 'DAY' THEN TO_CHAR(createdat, 'YYYY-MM-DD')
	                WHEN #{groupUnit} = 'WEEK' THEN TO_CHAR(createdat, 'IYYY-IW')
	                WHEN #{groupUnit} = 'MONTH' THEN TO_CHAR(createdat, 'YYYY-MM')
	                ELSE TO_CHAR(createdat, 'YYYY')
	            END AS group_label,
	            NVL(UPPER(producttype), '기타') AS category,
	            totalamount AS total_sales
	        FROM sales_item
	        WHERE status = 'ACTIVE'
	        <if test="categories != null and categories.size() > 0">
	            AND UPPER(producttype) IN (
	                <foreach collection="categories" item="cat" separator=",">
	                    UPPER(#{cat})
	                </foreach>
	            )
	        </if>
	        <if test="startDate != null and endDate != null">
	            AND createdat BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
	                              AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
	        </if>
	    ) merged
	    GROUP BY group_label, category
	    ORDER BY group_label ASC, category ASC
	</select>
    <!-- =======================================================
         [END] 전체 매출 그래프
    ======================================================== -->


    <!-- =======================================================
         [START] 서비스 매출 그래프
    ======================================================== -->
    <select id="selectServiceSalesChart" parameterType="map" resultType="map">
        SELECT 
            CASE 
                WHEN #{groupUnit} = 'DAY' THEN TO_CHAR(createdat, 'YYYY-MM-DD')
                WHEN #{groupUnit} = 'WEEK' THEN TO_CHAR(createdat, 'IYYY-IW')
                WHEN #{groupUnit} = 'MONTH' THEN TO_CHAR(createdat, 'YYYY-MM')
                ELSE TO_CHAR(createdat, 'YYYY')
            END AS group_label,
            NVL(UPPER(servicetype), '기타') AS label,
            SUM(actualamount) AS total_sales
        FROM sales_service
        WHERE status = 'ACTIVE'
          AND UPPER(servicetype) IN ('PT', 'VOUCHER')
          <if test="startDate != null and endDate != null">
              AND createdat BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
                                AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
          </if>
        GROUP BY 
            CASE 
                WHEN #{groupUnit} = 'DAY' THEN TO_CHAR(createdat, 'YYYY-MM-DD')
                WHEN #{groupUnit} = 'WEEK' THEN TO_CHAR(createdat, 'IYYY-IW')
                WHEN #{groupUnit} = 'MONTH' THEN TO_CHAR(createdat, 'YYYY-MM')
                ELSE TO_CHAR(createdat, 'YYYY')
            END, UPPER(servicetype)
        ORDER BY group_label ASC, total_sales DESC
    </select>
    <!-- =======================================================
         [END] 서비스 매출 그래프
    ======================================================== -->


    <!-- =======================================================
         [START] 실물 상품 매출 그래프
    ======================================================== -->
    <select id="selectItemSalesChart" parameterType="map" resultType="map">
        SELECT 
            CASE 
                WHEN #{groupUnit} = 'DAY' THEN TO_CHAR(createdat, 'YYYY-MM-DD')
                WHEN #{groupUnit} = 'WEEK' THEN TO_CHAR(createdat, 'IYYY-IW')
                WHEN #{groupUnit} = 'MONTH' THEN TO_CHAR(createdat, 'YYYY-MM')
                ELSE TO_CHAR(createdat, 'YYYY')
            END AS group_label,
            NVL(UPPER(producttype), '기타') AS label,
            SUM(totalamount) AS total_sales
        FROM sales_item
        WHERE status = 'ACTIVE'
          AND UPPER(producttype) IN ('CLOTHES', 'DRINK', 'SUPPLEMENTS')
          <if test="startDate != null and endDate != null">
              AND createdat BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
                                AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
          </if>
        GROUP BY 
            CASE 
                WHEN #{groupUnit} = 'DAY' THEN TO_CHAR(createdat, 'YYYY-MM-DD')
                WHEN #{groupUnit} = 'WEEK' THEN TO_CHAR(createdat, 'IYYY-IW')
                WHEN #{groupUnit} = 'MONTH' THEN TO_CHAR(createdat, 'YYYY-MM')
                ELSE TO_CHAR(createdat, 'YYYY')
            END, UPPER(producttype)
        ORDER BY group_label ASC, total_sales DESC
    </select>
    <!-- =======================================================
         [END] 실물 상품 매출 그래프
    ======================================================== -->


    <!-- =======================================================
         [START] 트레이너 실적 그래프
    ======================================================== -->
    <select id="selectTrainerPerformanceChart" parameterType="map" resultType="map">
        SELECT 
            CASE 
                WHEN #{groupUnit} = 'DAY' THEN TO_CHAR(p.used_at, 'YYYY-MM-DD')
                WHEN #{groupUnit} = 'WEEK' THEN TO_CHAR(p.used_at, 'IYYY-IW')
                WHEN #{groupUnit} = 'MONTH' THEN TO_CHAR(p.used_at, 'YYYY-MM')
                ELSE TO_CHAR(p.used_at, 'YYYY')
            END AS group_label,
            e.empname AS trainer_name,
            COUNT(p.pt_id) AS total_sessions
        FROM pt_log p
        JOIN employee e ON p.trainer_id = e.emp_id
        WHERE p.status = '소비'
          <if test="startDate != null and endDate != null">
              AND p.used_at BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
                                AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
          </if>
        <if test="trainerIds != null and trainerIds.size() > 0">
            AND (
                <foreach collection="trainerIds" item="tid" separator=" OR ">
                    p.trainer_id = #{tid}
                </foreach>
            )
        </if>
        <if test="trainerIds == null or trainerIds.size() == 0">
            AND p.trainer_id IN (
                SELECT trainer_id FROM (
                    SELECT trainer_id
                    FROM pt_log
                    WHERE status = '소비'
                    GROUP BY trainer_id
                    ORDER BY COUNT(pt_id) DESC
                    FETCH FIRST 3 ROWS ONLY
                )
            )
        </if>
        GROUP BY 
            CASE 
                WHEN #{groupUnit} = 'DAY' THEN TO_CHAR(p.used_at, 'YYYY-MM-DD')
                WHEN #{groupUnit} = 'WEEK' THEN TO_CHAR(p.used_at, 'IYYY-IW')
                WHEN #{groupUnit} = 'MONTH' THEN TO_CHAR(p.used_at, 'YYYY-MM')
                ELSE TO_CHAR(p.used_at, 'YYYY')
            END, e.empname
        ORDER BY group_label ASC, total_sessions DESC
    </select>
    <!-- =======================================================
         [END] 트레이너 실적 그래프
    ======================================================== -->


    <!-- =======================================================
         [START] AI 예측 관련 (회원 + 매출)
    ======================================================== -->
    <select id="selectAiMemberPredictions" resultType="map">
        SELECT 
            TO_CHAR(memcreated, 'YYYY-MM') AS month,
            COUNT(*) AS predictedCount,
            '실제' AS data_type
        FROM member
        GROUP BY TO_CHAR(memcreated, 'YYYY-MM')

        UNION ALL

        SELECT 
            TO_CHAR(predict_date, 'YYYY-MM') AS month,
            predicted_count AS predictedCount,
            '예측' AS data_type
        FROM ai_member_prediction
        ORDER BY month ASC
    </select>

    <select id="selectAiSalesPredictions" resultType="map">
        SELECT 
            TO_CHAR(createdat, 'YYYY') AS year,
            TO_CHAR(createdat, 'MM') AS month,
            SUM(total_sales) AS predictedSales,
            '실제' AS data_type
        FROM (
            SELECT createdat, actualamount AS total_sales FROM sales_service
            UNION ALL
            SELECT createdat, totalamount AS total_sales FROM sales_item
        )
        WHERE TO_CHAR(createdat, 'YYYY') IN (
            TO_CHAR(ADD_MONTHS(SYSDATE, -12), 'YYYY'),
            TO_CHAR(SYSDATE, 'YYYY')
        )
        GROUP BY TO_CHAR(createdat, 'YYYY'), TO_CHAR(createdat, 'MM')

        UNION ALL

        SELECT 
            predict_year AS year,
            LPAD(predict_month, 2, '0') AS month,
            predicted_sales AS predictedSales,
            '예측' AS data_type
        FROM ai_sales_prediction
        WHERE predict_year = TO_NUMBER(TO_CHAR(SYSDATE, 'YYYY')) + 1

        ORDER BY year ASC, month ASC
    </select>
    <!-- =======================================================
         [END] AI 예측 관련
    ======================================================== -->
    
    
    
    <!-- =======================================================
         [START] AI 회원 예측용 월별 회원 수 집계
         - 대상 테이블: MEMBER
         - 설명:
             · created_at 기준 월별 신규 회원 수 집계
             · Flask의 /predict/members 에 전달할 monthly_counts 생성용
    ======================================================== -->
    <select id="selectMemberMonthlyCount" parameterType="map" resultType="map">
	    SELECT 
	        TO_CHAR(MEMCREATED, 'YYYY-MM') AS month,
	        COUNT(*) AS member_count
	    FROM member
	    WHERE MEMCREATED BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD')
	                         AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
	    GROUP BY TO_CHAR(MEMCREATED, 'YYYY-MM')
	    ORDER BY TO_CHAR(MEMCREATED, 'YYYY-MM')
	</select>
    <!-- =======================================================
         [END] AI 회원 예측용 월별 회원 수 집계
    ======================================================== -->
    
    
    <!-- =======================================================
	     [START] AI 회원 예측 결과 저장
	     - 테이블: ai_member_prediction
	     - 컬럼:
	         · predict_id        : 기본키 (시퀀스)
	         · predict_date      : 예측 기준일 (YYYY-MM-DD)
	         · predicted_count   : 예측된 회원 수 (소수 가능)
	         · created_at        : 생성일 (SYSDATE)
	======================================================= -->
	<insert id="insertAiMemberPrediction" parameterType="map">
	    INSERT INTO ai_member_prediction (
	        predict_id,
	        predict_date,
	        predicted_count,
	        created_at
	    ) VALUES (
	        ai_member_prediction_seq.NEXTVAL,
	        TO_DATE(#{predictDate}, 'YYYY-MM-DD'),
	        #{predictedCount, jdbcType=DECIMAL},
	        SYSDATE
	    )
	</insert>
	<!-- =======================================================
	     [END] AI 회원 예측 결과 저장
	======================================================= -->
    

</mapper>
