<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="SalesAnalyticsMapper">

    <!-- ===============================
         [1] ì „ì²´ ë§¤ì¶œ ê·¸ëž˜í”„ (ìµœê·¼ 30ì¼ ê¸°ì¤€)
         - SERVICE: PT, VOUCHER
         - ITEM: CLOTHES, DRINK, SUPPLEMENTS
         - ê¸°ì¤€ì¼: SYSDATE (ì˜¤ëŠ˜)
         - ë²”ìœ„: SYSDATE - 30 ~ SYSDATE
    =============================== -->
    <select id="selectTotalSalesChart" resultType="map">
        

        SELECT 'PT' AS label, NVL(SUM(actualamount), 0) AS total_sales
        FROM sales_service
        WHERE UPPER(status) = 'ACTIVE'
          AND UPPER(servicetype) = 'PT'
          AND createdat BETWEEN SYSDATE - 30 AND SYSDATE

        UNION ALL

        SELECT 'VOUCHER' AS label, NVL(SUM(actualamount), 0) AS total_sales
        FROM sales_service
        WHERE UPPER(status) = 'ACTIVE'
          AND UPPER(servicetype) = 'VOUCHER'
          AND createdat BETWEEN SYSDATE - 30 AND SYSDATE

        UNION ALL

        SELECT 'CLOTHES' AS label, NVL(SUM(totalamount), 0) AS total_sales
        FROM sales_item
        WHERE UPPER(status) = 'ACTIVE'
          AND UPPER(producttype) = 'CLOTHES'
          AND createdat BETWEEN SYSDATE - 30 AND SYSDATE

        UNION ALL

        SELECT 'DRINK' AS label, NVL(SUM(totalamount), 0) AS total_sales
        FROM sales_item
        WHERE UPPER(status) = 'ACTIVE'
          AND UPPER(producttype) = 'DRINK'
          AND createdat BETWEEN SYSDATE - 30 AND SYSDATE

        UNION ALL

        SELECT 'SUPPLEMENTS' AS label, NVL(SUM(totalamount), 0) AS total_sales
        FROM sales_item
        WHERE UPPER(status) = 'ACTIVE'
          AND UPPER(producttype) = 'SUPPLEMENTS'
          AND createdat BETWEEN SYSDATE - 30 AND SYSDATE
    </select>



    <!-- ===============================
         [2] ì„œë¹„ìŠ¤ ë§¤ì¶œ ê·¸ëž˜í”„
         - ì¤‘ë¶„ë¥˜: PT, VOUCHER (2ì¢…)
         - ì „ì²´ê¸°ê°„ ê¸°ì¤€
    =============================== -->
    <select id="selectServiceSalesChart" resultType="map">
        SELECT 
            UPPER(service_type) AS label,
            NVL(SUM(actualamount), 0) AS total_sales
        FROM sales_service
        WHERE UPPER(status) = 'ACTIVE'
          AND UPPER(service_type) IN ('PT', 'VOUCHER')
        GROUP BY UPPER(service_type)
        ORDER BY label
    </select>


    <!-- ===============================
         [3] ì‹¤ë¬¼ ìƒí’ˆ ë§¤ì¶œ ê·¸ëž˜í”„
         - ì¤‘ë¶„ë¥˜: CLOTHES, DRINK, SUPPLEMENTS (3ì¢…)
         - ì „ì²´ê¸°ê°„ ê¸°ì¤€
    =============================== -->
    <select id="selectItemSalesChart" resultType="map">
        SELECT 
            UPPER(product_type) AS label,
            NVL(SUM(totalamount), 0) AS total_sales
        FROM sales_item
        WHERE UPPER(status) = 'ACTIVE'
          AND UPPER(product_type) IN ('CLOTHES', 'DRINK', 'SUPPLEMENTS')
        GROUP BY UPPER(product_type)
        ORDER BY label
    </select>


    <!-- ===============================
         [4] íŠ¸ë ˆì´ë„ˆ ì‹¤ì  ê·¸ëž˜í”„
         - ì§€ë‚œë‹¬ ê¸°ì¤€, ë§¤ì¶œ ìƒìœ„ 5ëª…
    =============================== -->
    <select id="selectTrainerPerformanceChart" resultType="map">
        SELECT *
        FROM (
            SELECT 
                e.empname AS label,
                NVL(SUM(p.countchange), 0) AS total_sessions
            FROM pt_log p
            JOIN employee e ON p.empnum = e.empnum
            WHERE TO_CHAR(p.createdat, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYY-MM')
              AND p.status IN ('ì†Œë¹„', 'ì˜ˆì•½ì·¨ì†Œ')
            GROUP BY e.empname
            ORDER BY total_sessions DESC
        )
        WHERE ROWNUM &lt;= 5
    </select>


    <!-- ===============================
         [5] AI íšŒì› ì˜ˆì¸¡ ê·¸ëž˜í”„ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ ìœ ì§€)
    =============================== -->
    <select id="selectAiMemberPredictions" resultType="map">
        SELECT 
            TO_CHAR(memcreated, 'YYYY-MM') AS month,
            COUNT(*) AS predictedCount,
            'ì‹¤ì œ' AS data_type
        FROM member
        WHERE memcreated &lt; TRUNC(ADD_MONTHS(SYSDATE, 0), 'MM')
        GROUP BY TO_CHAR(memcreated, 'YYYY-MM')
    
        UNION ALL
    
        SELECT 
            TO_CHAR(predict_date, 'YYYY-MM') AS month,
            predicted_count AS predictedCount,
            'ì˜ˆì¸¡' AS data_type
        FROM ai_member_prediction
    
        ORDER BY month ASC
    </select>


    <!-- ===============================
         [6] AI íšŒì› ì˜ˆì¸¡ ê²°ê³¼ ì €ìž¥ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ ìœ ì§€)
    =============================== -->
    <insert id="insertAiMemberPrediction" parameterType="map">
        INSERT INTO ai_member_prediction (
            predict_id,
            predict_date,
            predicted_count,
            created_at
        ) VALUES (
            ai_member_prediction_seq.NEXTVAL,
            TO_DATE(#{predictDate}, 'YYYY-MM-DD'),
            #{predictedCount, jdbcType=DECIMAL},
            SYSDATE
        )
    </insert>
    
    
    <!-- ===============================
         [1] ì œìž‘ë…„~ì˜¬í•´ ë§¤ì¶œ ì¡°íšŒ
         - ì‹¤ì œ ë§¤ì¶œ ë°ì´í„° (sales_service + sales_item)
         - ì»¬ëŸ¼: totalamount, actualamount
         - ê¸°ê°„: ì œìž‘ë…„, ìž‘ë…„, ì˜¬í•´
         - ë‹¨ìœ„: ì›”ë³„ í•©ê³„
    =============================== -->
    <select id="selectActualSales3Years" resultType="map">
        SELECT
            EXTRACT(YEAR FROM s.sales_date) AS year,
            EXTRACT(MONTH FROM s.sales_date) AS month,
            SUM(s.totalamount) AS totalamount,
            SUM(s.actualamount) AS actualamount
        FROM (
            SELECT sales_date, totalamount, actualamount FROM sales_service
            UNION ALL
            SELECT sales_date, totalamount, totalamount AS actualamount FROM sales_item
        ) s
        WHERE EXTRACT(YEAR FROM s.sales_date)
              BETWEEN EXTRACT(YEAR FROM SYSDATE) - 2
              AND EXTRACT(YEAR FROM SYSDATE)
        GROUP BY EXTRACT(YEAR FROM s.sales_date), EXTRACT(MONTH FROM s.sales_date)
        ORDER BY year, month
    </select>


    <!-- ===============================
         [2] ìž‘ë…„ + ì˜¬í•´ + ë‚´ë…„(ì˜ˆì¸¡) ì¡°íšŒ
         - ì‹¤ì œ ë§¤ì¶œ(sales_service, sales_item)
         - ì˜ˆì¸¡ ë§¤ì¶œ(AI_SALES_PREDICTION)
         - ì»¬ëŸ¼ í†µì¼: totalamount, actualamount
         - ì˜ˆì¸¡ í…Œì´ë¸”: predict_year, predict_month, predicted_sales
         - ë‹¨ìœ„: ì›”ë³„ í•©ê³„ (ðŸ’° ë§¤ì¶œ ê¸ˆì•¡ ê¸°ì¤€)
    =============================== -->
    <select id="selectSalesWithPrediction" resultType="map">
        SELECT
            year,
            month,
            SUM(totalamount) AS totalamount,
            SUM(predicted_sales) AS predicted_sales
        FROM (
            SELECT
                EXTRACT(YEAR FROM s.createdat) AS year,
                EXTRACT(MONTH FROM s.createdat) AS month,
                SUM(s.amount) AS totalamount,
                0 AS predicted_sales
            FROM (
                SELECT createdat, actualamount AS amount
                FROM sales_service
                WHERE UPPER(status) = 'ACTIVE'
    
                UNION ALL
    
                SELECT createdat, totalamount AS amount
                FROM sales_item
                WHERE UPPER(status) = 'ACTIVE'
            ) s
            WHERE EXTRACT(YEAR FROM s.createdat)
                  BETWEEN EXTRACT(YEAR FROM SYSDATE) - 1
                  AND EXTRACT(YEAR FROM SYSDATE)
            GROUP BY EXTRACT(YEAR FROM s.createdat), EXTRACT(MONTH FROM s.createdat)
    
            UNION ALL
    
            SELECT
                p.predict_year AS year,
                p.predict_month AS month,
                0 AS totalamount,
                p.predicted_sales AS predicted_sales
            FROM ai_sales_prediction p
            WHERE p.predict_year = EXTRACT(YEAR FROM SYSDATE) + 1
        )
        GROUP BY year, month
        ORDER BY year, month
    </select>
    
    <!-- ===============================
         [íšŒì›ê¶Œ ìœ íš¨ íšŒì› ë¹„ìœ¨ í†µê³„]
         - ì „ì²´ íšŒì›ê¶Œ ë‚´ì—­ ë³´ìœ  íšŒì› ê¸°ì¤€
         - endDate >= SYSDATE â†’ ìœ íš¨
         - endDate < SYSDATE â†’ ë§Œë£Œ
    =============================== -->
    <select id="selectValidVoucherStats" resultType="map">
        SELECT
            COUNT(DISTINCT CASE WHEN v.endDate &gt;= SYSDATE THEN v.memNum END) AS valid,
            COUNT(DISTINCT CASE WHEN v.endDate &lt; SYSDATE THEN v.memNum END) AS expired
        FROM voucher_log v
        WHERE v.memNum IS NOT NULL
    </select>
    
    
    <!-- ===============================
         [PT ìž”ì—¬íšŸìˆ˜ íšŒì› í†µê³„ - Bì•ˆ]
         - pt_log.countChange ì´í•©ìœ¼ë¡œ ìž”ì—¬ ê³„ì‚°
         - ê¸°ì¤€: íšŒì›(memNum)ë³„ SUM(countChange)
    =============================== -->
    <select id="selectRemainingPtStats" resultType="map">
        SELECT
            COUNT(CASE WHEN total_remain &gt; 0 THEN 1 END) AS remaining_count,
            COUNT(CASE WHEN total_remain &lt;= 0 THEN 1 END) AS exhausted_count
        FROM (
            SELECT memNum, SUM(countChange) AS total_remain
            FROM pt_log
            GROUP BY memNum
        )
    </select>

</mapper>
