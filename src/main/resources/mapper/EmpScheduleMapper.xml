<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="EmpScheduleMapper">


 <!-- 전체 조회 (Registration / Vacation / Etc 상세 포함) -->
    <select id="selectAll" resultType="EmpScheduleDto">
        SELECT e.*,
            CASE e.refType
                WHEN 'registration' THEN r.detail
                WHEN 'vacation' THEN v.detail
                WHEN 'etc' THEN t.detail
                ELSE e.memo
            END AS refDetail
        FROM EmpSchedule e
        LEFT JOIN Registration r
            ON e.refType = 'registration' AND e.refId = r.regNum
        LEFT JOIN Vacation v
            ON e.refType = 'vacation' AND e.refId = v.vacNum
        LEFT JOIN Etc t
            ON e.refType = 'etc' AND e.refId = t.etcNum
        ORDER BY e.date, e.startTime
    </select>

    <!-- PK 단건 조회 -->
    <select id="selectByCalNum" resultType="EmpScheduleDto">
        SELECT e.*,
            CASE e.ref_type
                WHEN 'registration' THEN r.detail
                WHEN 'vacation' THEN v.detail
                WHEN 'etc' THEN t.detail
                ELSE e.memo
            END AS refDetail
        FROM EmpSchedule e
        LEFT JOIN Registration r
            ON e.refType = 'registration' AND e.refId = r.regNum
        LEFT JOIN Vacation v
            ON e.refType = 'vacation' AND e.refId = v.vacNum
        LEFT JOIN Etc t
            ON e.refType = 'etc' AND e.refId = t.etcNum
        WHERE e.calNum = #{calNum}
    </select>

    <!-- 직원 + 날짜 범위 조회 -->
    <select id="selectByEmpAndDate" resultType="EmpScheduleDto">
        SELECT e.*,
            CASE e.ref_type
                WHEN 'registration' THEN r.detail
                WHEN 'vacation' THEN v.detail
                WHEN 'etc' THEN t.detail
                ELSE e.memo
            END AS refDetail
        FROM EmpSchedule e
        LEFT JOIN Registration r
            ON e.refType = 'registration' AND e.refId = r.regNum
        LEFT JOIN Vacation v
           ON e.refType = 'vacation' AND e.refId = v.vacNum
        LEFT JOIN Etc t
             ON e.refType = 'etc' AND e.refId = t.etcNum
        WHERE e.empNum = #{empNum}
          AND e.date BETWEEN #{startDate} AND #{endDate}
        ORDER BY e.date, e.startTime
    </select>

    <!-- 수정 -->
    <update id="update" parameterType="EmpScheduleDto">
        UPDATE EmpSchedule
        SET color = #{color},
            ref_type = #{refType},
            ref_id = #{refId},
            date = #{date},
            start_time = #{startTime},
            end_time = #{endTime},
            memo = #{memo}
        WHERE cal_num = #{calNum}
    </update>

    <!-- 삭제 -->
    <delete id="delete" parameterType="int">
        DELETE FROM EmpSchedule
        WHERE cal_num = #{calNum}
    </delete>

</mapper>

