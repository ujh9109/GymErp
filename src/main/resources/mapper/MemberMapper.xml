<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 인터페이스 매퍼용: MemberDao의 FQCN을 namespace로 -->
<mapper namespace="MemberMapper">

	<!-- 공통 결과 매핑 -->
	<resultMap id="MemberWithStatsMap" type="MemberDto">
		<id     property="memNum" column="memNum"/>
		<result property="memName" column="memName"/>
		<result property="memGender" column="memGender"/>
		<result property="memBirthday" column="memBirthday"/>
		<result property="memPhone" column="memPhone"/>
		<result property="memEmail" column="memEmail"/>
		<result property="memAddr" column="memAddr"/>
		<result property="memCreated" column="memCreated"/>
		<result property="memUpdated" column="memUpdated"/>
		<result property="memProfile" column="memProfile"/>
		<result property="memNote" column="memNote"/>
		
		<!-- 계산/조인 필드 -->
		<result property="trainerName"      column="trainerName"/>
		<result property="voucherStartDate" column="voucherStartDate"/>
		<result property="voucherEndDate"   column="voucherEndDate"/>
		<result property="ptRemain"         column="ptRemain"/>
		<result property="membershipStatus" column="membershipStatus"/>
	</resultMap>
	  <!-- 전체 + 통계 (상태 필터/정렬) -->
  <select id="selectAllWithStats" parameterType="map" resultMap="MemberWithStatsMap">
    WITH latest_voucher AS (
      SELECT memNum, voucherId, startDate, endDate
      FROM (
        SELECT v.*,
               ROW_NUMBER() OVER (PARTITION BY v.memNum ORDER BY v.endDate DESC, v.voucherId DESC) rn
        FROM voucher_log v
      ) WHERE rn = 1
    ),
    last_trainer AS (
      SELECT memNum,
             MAX(empNum) KEEP (DENSE_RANK LAST ORDER BY createdAt, usageId) AS empNum
      FROM pt_log
      GROUP BY memNum
    ),
    pt_balance AS (
      SELECT memNum, NVL(SUM(countChange),0) AS ptRemain
      FROM pt_log
      GROUP BY memNum
    )
    SELECT
      m.memNum, m.memName, m.memGender, m.memBirthday, m.memPhone, m.memEmail,
      m.memAddr, m.memCreated, m.memUpdated, m.memProfile, m.memNote,
      e.empName AS trainerName,
      lv.startDate AS voucherStartDate,
      lv.endDate   AS voucherEndDate,
      pb.ptRemain  AS ptRemain,
      CASE
        WHEN lv.endDate IS NULL THEN '미사용중'
        WHEN lv.endDate &lt; TRUNC(SYSDATE) THEN '미사용중'
        ELSE '사용중'
      END AS membershipStatus,
      CASE
        WHEN lv.endDate IS NULL THEN 1
        WHEN lv.endDate &lt; TRUNC(SYSDATE) THEN 1
        ELSE 0
      END AS statusSort  -- 1=미사용중 먼저. 사용중 먼저로 바꾸려면 0/1을 뒤집거나 ORDER BY를 ASC로 변경
    FROM MEMBER m
    LEFT JOIN last_trainer lt ON lt.memNum = m.memNum
    LEFT JOIN employee    e  ON e.empNum  = lt.empNum
    LEFT JOIN latest_voucher lv ON lv.memNum = m.memNum
    LEFT JOIN pt_balance pb   ON pb.memNum = m.memNum
    WHERE
      ( #{status,jdbcType=VARCHAR} IS NULL
        OR UPPER(#{status}) = 'ALL'
        OR (UPPER(#{status}) = 'USING'
              AND lv.endDate IS NOT NULL
              AND lv.endDate >= TRUNC(SYSDATE)
           )
        OR (UPPER(#{status}) = 'NOT_USING'
              AND (lv.endDate IS NULL OR lv.endDate &lt; TRUNC(SYSDATE))
           )
      )
    ORDER BY statusSort DESC, m.memCreated DESC
  </select>

  <!-- 단건 상세 + 통계 -->
  <select id="getWithStats" parameterType="int" resultMap="MemberWithStatsMap">
    WITH latest_voucher AS (
      SELECT memNum, voucherId, startDate, endDate
      FROM (
        SELECT v.*,
               ROW_NUMBER() OVER (PARTITION BY v.memNum ORDER BY v.endDate DESC, v.voucherId DESC) rn
        FROM voucher_log v
      ) WHERE rn = 1
    ),
    last_trainer AS (
      SELECT memNum,
             MAX(empNum) KEEP (DENSE_RANK LAST ORDER BY createdAt, usageId) AS empNum
      FROM pt_log
      GROUP BY memNum
    ),
    pt_balance AS (
      SELECT memNum, NVL(SUM(countChange),0) AS ptRemain
      FROM pt_log
      GROUP BY memNum
    )
    SELECT
      m.memNum, m.memName, m.memGender, m.memBirthday, m.memPhone, m.memEmail,
      m.memAddr, m.memCreated, m.memUpdated, m.memProfile, m.memNote,
      e.empName AS trainerName,
      lv.startDate AS voucherStartDate,
      lv.endDate   AS voucherEndDate,
      pb.ptRemain  AS ptRemain,
      CASE
        WHEN lv.endDate IS NULL THEN '미사용중'
        WHEN lv.endDate &lt; TRUNC(SYSDATE) THEN '미사용중'
        ELSE '사용중'
      END AS membershipStatus
    FROM MEMBER m
    LEFT JOIN last_trainer lt ON lt.memNum = m.memNum
    LEFT JOIN employee    e  ON e.empNum  = lt.empNum
    LEFT JOIN latest_voucher lv ON lv.memNum = m.memNum
    LEFT JOIN pt_balance pb   ON pb.memNum = m.memNum
    WHERE m.memNum = #{memNum}
  </select>
	
    <!-- 전체 회원 조회 -->
    <select id="selectAll" resultType="MemberDto">
        SELECT memNum, memName, memGender, memBirthday, memPhone, memEmail,
               memAddr, memCreated, memUpdated, memProfile, memNote
        FROM MEMBER
        ORDER BY memCreated DESC
    </select>

    <!-- 회원 상세 조회 -->
    <select id="getByNum" parameterType="int" resultType="MemberDto">
        SELECT memNum, memName, memGender, memBirthday, memPhone, memEmail,
               memAddr, memCreated, memUpdated, memProfile, memNote
        FROM MEMBER
        WHERE memNum = #{memNum}
    </select>

    <!-- 회원 등록 -->
    <insert id="insert" parameterType="MemberDto">
        <selectKey keyProperty="memNum" resultType="int" order="BEFORE">
            SELECT MEMBER_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO MEMBER (
            memNum, memName, memGender, memBirthday, memPhone,
            memEmail, memAddr, memCreated, memUpdated, memProfile, memNote
        ) VALUES (
            #{memNum},
            #{memName,    jdbcType=VARCHAR},
            #{memGender,  jdbcType=VARCHAR},
            #{memBirthday,jdbcType=DATE},
            #{memPhone,   jdbcType=VARCHAR},
            #{memEmail,   jdbcType=VARCHAR},
            #{memAddr,    jdbcType=VARCHAR},
            SYSTIMESTAMP,
            SYSTIMESTAMP,
            #{memProfile, jdbcType=VARCHAR},
            #{memNote,    jdbcType=VARCHAR}
        )
    </insert>

    <!-- 회원 수정 -->
    <update id="update" parameterType="MemberDto">
        UPDATE MEMBER
        SET
            memName     = #{memName,    jdbcType=VARCHAR},
            memGender   = #{memGender,  jdbcType=VARCHAR},
            memBirthday = #{memBirthday,jdbcType=DATE},
            memPhone    = #{memPhone,   jdbcType=VARCHAR},
            memEmail    = #{memEmail,   jdbcType=VARCHAR},
            memAddr     = #{memAddr,    jdbcType=VARCHAR},
            memProfile  = #{memProfile, jdbcType=VARCHAR},
            memNote     = #{memNote,    jdbcType=VARCHAR},
            memUpdated  = SYSTIMESTAMP
        WHERE memNum = #{memNum}
    </update>

    <!-- 회원 삭제 (물리삭제, 추후 상태 컬럼으로 변경 가능) -->
    <delete id="delete" parameterType="int">
        DELETE FROM MEMBER
        WHERE memNum = #{memNum}
    </delete>

    

    <!-- 이용내역 DB 관련 내용입니다.  -->
    
    
     <!-- 회원 이름 단건 조회 (로그용) -->



    <!-- 회원 이름 조회 -->
    <select id="selectMemberNameById" parameterType="int" resultType="string">
        SELECT memName
        FROM MEMBER
        WHERE memNum = #{memNum}
    </select>

    <!-- 회원 존재 여부 확인 -->
    <select id="checkMemberExists" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM MEMBER
        WHERE memNum = #{memNum}
    </select>

    <!-- 프로필 이미지 수정 -->
    <update id="updateProfile" parameterType="MemberDto">
        UPDATE MEMBER
        SET memProfile = #{memProfile, jdbcType=VARCHAR},
            memUpdated = SYSTIMESTAMP
        WHERE memNum = #{memNum}
    </update>

    <!-- 회원 검색 -->
    <select id="search" resultType="MemberDto">
        SELECT memNum, memName, memGender, memBirthday, memPhone, memEmail,
               memAddr, memCreated, memUpdated, memProfile, memNote
        FROM MEMBER
        WHERE
            LOWER(memName)  LIKE LOWER('%' || #{keyword} || '%')
        OR  LOWER(memPhone) LIKE LOWER('%' || #{keyword} || '%')
        OR  LOWER(memEmail) LIKE LOWER('%' || #{keyword} || '%')
        ORDER BY memCreated DESC
    </select>

</mapper>
