<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ModalMapper">

    <!-- =========================================================
	     [서비스 상품 선택 모달]
	     - 테이블: SERVICE
	     - DTO: ServiceDto
	     - 조건:
	         · ISACTIVE = 1 (활성 상품만)
	         · keyword 입력 시 NAME LIKE 검색
	         · categoryCodes 존재 시 CODEBID IN 조건 필터
	     - 정렬:
	         · CODEBID LIKE '%PT%' → 최상위
	         · NAME 내림차순
	     - 페이징:
	         · ROWNUM BETWEEN startRowNum AND endRowNum
	========================================================= -->
	<select id="getServiceModalList" resultType="ServiceDto">
	    SELECT *
	    FROM (
	        SELECT
	            ROWNUM AS rn,
	            s.SERVICEID    AS serviceId,
	            s.CODEBID      AS codeBId,
	            s.NAME         AS name,
	            s.PRICE        AS price,
	            s.ISACTIVE     AS isActive,
	            s.SERVICEVALUE AS serviceValue,
	            s.CREATEDAT    AS createdAt,
	            s.UPDATEDAT    AS updatedAt,
	            s.NOTE         AS note
	        FROM SERVICE s
	        WHERE s.ISACTIVE = 1
	
	        <!-- 검색어 필터 -->
	        <if test="keyword != null and keyword != ''">
	            AND LOWER(s.NAME) LIKE '%' || LOWER(#{keyword}) || '%'
	        </if>
	
	        <!-- 카테고리 코드 필터 -->
	        <if test="categoryCodes != null and categoryCodes.size() > 0">
	            AND s.CODEBID IN
	            <foreach collection="categoryCodes" item="code" open="(" separator="," close=")">
	                #{code}
	            </foreach>
	        </if>
	
	        ORDER BY
	            CASE WHEN s.CODEBID LIKE '%PT%' THEN 0 ELSE 1 END,
	            s.NAME DESC
	    )
	    WHERE rn BETWEEN #{startRowNum} AND #{endRowNum}
	</select>
	
	<!-- =========================================================
	     [서비스 상품 총 개수 조회]
	     - 동일 조건 COUNT(*)
	========================================================= -->
	<select id="getServiceModalCount" resultType="int">
	    SELECT COUNT(*)
	    FROM SERVICE s
	    WHERE s.ISACTIVE = 1
	
	    <if test="keyword != null and keyword != ''">
	        AND LOWER(s.NAME) LIKE '%' || LOWER(#{keyword}) || '%'
	    </if>
	
	    <if test="categoryCodes != null and categoryCodes.size() > 0">
	        AND s.CODEBID IN
	        <foreach collection="categoryCodes" item="code" open="(" separator="," close=")">
	            #{code}
	        </foreach>
	    </if>
	</select>

    <!-- ================================
         서비스 상품 선택 모달 끝
    ================================= -->
    
    
    
     <!-- ================================
         실물 상품 선택 모달
    ================================= -->

	<!-- 상품 모달 목록 (11g 호환) -->
	<select id="getProductModalList" parameterType="map"
	        resultType="com.example.gymerp.dto.ProductDto">
	  SELECT productId, codeBId, name, price, isActive
	  FROM (
	    SELECT
	      p.productId,
	      p.codeBId,
	      p.name,
	      p.price,
	      p.isActive,
	      ROW_NUMBER() OVER (ORDER BY p.name DESC) AS rn
	    FROM PRODUCT p
	    WHERE p.isActive = 1
	      <if test="keyword != null and keyword != ''">
	        AND UPPER(p.name) LIKE '%' || UPPER(#{keyword}) || '%'
	      </if>
	  )
	  WHERE rn BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<!-- 총 개수 -->
	<select id="getProductModalCount" parameterType="map" resultType="int">
	  SELECT COUNT(1)
	  FROM PRODUCT p
	  WHERE p.isActive = 1
	    <if test="keyword != null and keyword != ''">
	      AND UPPER(p.name) LIKE '%' || UPPER(#{keyword}) || '%'
	    </if>
	</select>

    
    <!-- ================================
         실물 상품 선택 모달 끝
    ================================= -->    

    <!-- ================================
         직원 선택 모달
    ================================= -->
<!-- 직원 모달 목록 -->
<!-- 목록 -->
	<select id="getEmployeeModalList" parameterType="map"
	        resultType="com.example.gymerp.dto.EmpDto">
	  SELECT empNum, empName, empEmail
	  FROM (
	    SELECT
	      e.EMPNUM   AS empNum,
	      e.EMPNAME  AS empName,
	      e.EMPEMAIL AS empEmail,
	      ROW_NUMBER() OVER (ORDER BY e.EMPNAME ASC) AS rn
	    FROM EMPLOYEE e
	    WHERE e.FIREDATE IS NULL
	      <if test="keyword != null and keyword != ''">
	        AND ( UPPER(e.EMPNAME)  LIKE '%' || UPPER(#{keyword}) || '%'
	           OR UPPER(e.EMPEMAIL) LIKE '%' || UPPER(#{keyword}) || '%' )
	      </if>
	  )
	  WHERE rn BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<!-- 전체 개수 -->
	<select id="getEmployeeModalCount" parameterType="map" resultType="int">
	  SELECT COUNT(1)
	  FROM EMPLOYEE e
	  WHERE e.FIREDATE IS NULL
	    <if test="keyword != null and keyword != ''">
	      AND ( UPPER(e.EMPNAME)  LIKE '%' || UPPER(#{keyword}) || '%'
	         OR UPPER(e.EMPEMAIL) LIKE '%' || UPPER(#{keyword}) || '%' )
	    </if>
	</select>

    <!-- ================================
         직원 선택 모달 끝
    ================================= -->
    
    <!-- ================================
         회원 선택 모달
    ================================= -->
    
    
    <!-- ================================
         회원 선택 모달 끝
    ================================= -->    

</mapper>
