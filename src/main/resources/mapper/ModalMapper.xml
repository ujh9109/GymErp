<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ModalMapper">

    <!-- ================================
         서비스 상품 선택 모달
    ================================= -->

    <!-- 서비스 상품 목록 조회 -->
    <select id="getServiceModalList" resultType="ServiceDto">
        SELECT
            serviceId,
            codeBid,
            name,
            price,
            isActive
        FROM Service
        WHERE isActive = 1
        <if test="keyword != null and keyword != ''">
            AND name LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY
            CASE WHEN codeBid = 'PT' THEN 1 ELSE 2 END,
            name DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 서비스 상품 전체 개수 조회 -->
    <select id="getServiceModalCount" resultType="int">
        SELECT COUNT(*)
        FROM Service
        WHERE isActive = 1
        <if test="keyword != null and keyword != ''">
            AND name LIKE CONCAT('%', #{keyword}, '%')
        </if>
    </select>
    
    <!-- ================================
         서비스 상품 선택 모달 끝
    ================================= -->    

    <!-- ================================
         실물 상품 선택 모달
    ================================= -->

	<!-- 상품 모달 목록 (11g 호환) -->
	<select id="getProductModalList" parameterType="map"
	        resultType="com.example.gymerp.dto.ProductDto">
	  SELECT productId, codeBId, name, price, isActive
	  FROM (
	    SELECT
	      p.productId,
	      p.codeBId,
	      p.name,
	      p.price,
	      p.isActive,
	      ROW_NUMBER() OVER (ORDER BY p.name DESC) AS rn
	    FROM PRODUCT p
	    WHERE p.isActive = 1
	      <if test="keyword != null and keyword != ''">
	        AND UPPER(p.name) LIKE '%' || UPPER(#{keyword}) || '%'
	      </if>
	  )
	  WHERE rn BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<!-- 총 개수 -->
	<select id="getProductModalCount" parameterType="map" resultType="int">
	  SELECT COUNT(1)
	  FROM PRODUCT p
	  WHERE p.isActive = 1
	    <if test="keyword != null and keyword != ''">
	      AND UPPER(p.name) LIKE '%' || UPPER(#{keyword}) || '%'
	    </if>
	</select>

    
    <!-- ================================
         실물 상품 선택 모달 끝
    ================================= -->    

    <!-- ================================
         직원 선택 모달
    ================================= -->
<!-- 직원 모달 목록 -->
<!-- 목록 -->
	<select id="getEmployeeModalList" parameterType="map"
	        resultType="com.example.gymerp.dto.EmpDto">
	  SELECT empNum, empName, empEmail
	  FROM (
	    SELECT
	      e.EMPNUM   AS empNum,
	      e.EMPNAME  AS empName,
	      e.EMPEMAIL AS empEmail,
	      ROW_NUMBER() OVER (ORDER BY e.EMPNAME ASC) AS rn
	    FROM EMPLOYEE e
	    WHERE e.FIREDATE IS NULL
	      <if test="keyword != null and keyword != ''">
	        AND ( UPPER(e.EMPNAME)  LIKE '%' || UPPER(#{keyword}) || '%'
	           OR UPPER(e.EMPEMAIL) LIKE '%' || UPPER(#{keyword}) || '%' )
	      </if>
	  )
	  WHERE rn BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<!-- 전체 개수 -->
	<select id="getEmployeeModalCount" parameterType="map" resultType="int">
	  SELECT COUNT(1)
	  FROM EMPLOYEE e
	  WHERE e.FIREDATE IS NULL
	    <if test="keyword != null and keyword != ''">
	      AND ( UPPER(e.EMPNAME)  LIKE '%' || UPPER(#{keyword}) || '%'
	         OR UPPER(e.EMPEMAIL) LIKE '%' || UPPER(#{keyword}) || '%' )
	    </if>
	</select>

    <!-- ================================
         직원 선택 모달 끝
    ================================= -->
    
    <!-- ================================
         회원 선택 모달
    ================================= -->
    
    
    <!-- ================================
         회원 선택 모달 끝
    ================================= -->    

</mapper>
