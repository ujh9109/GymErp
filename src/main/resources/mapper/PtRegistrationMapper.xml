<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="PtRegistrationMapper">

  <!-- 전체 예약 목록 조회 -->
  <select id="getAllPtRegistration" resultType="com.example.gymerp.dto.PtRegistrationDto">
    SELECT 
      REGNUM, EMPNUM, MEMNUM, SHNUM,
      REGCREATED, REGUPDATEDAT, REGNOTE
    FROM REGISTRATION
    ORDER BY REGNUM DESC
  </select>

  <!-- 단일 예약 조회 -->
  <select id="getPtRegistrationById" parameterType="long" resultType="com.example.gymerp.dto.PtRegistrationDto">
    SELECT 
      REGNUM, EMPNUM, MEMNUM, SHNUM,
      REGCREATED, REGUPDATEDAT, REGNOTE
    FROM REGISTRATION
    WHERE REGNUM = #{regNum, javaType=long, jdbcType=NUMERIC}
  </select>

  <!-- 일정번호(shNum)로 조회 -->
  <select id="getByShNum" parameterType="long" resultType="com.example.gymerp.dto.PtRegistrationDto">
    SELECT 
      REGNUM, EMPNUM, MEMNUM, SHNUM,
      REGCREATED, REGUPDATEDAT, REGNOTE
    FROM REGISTRATION
    WHERE SHNUM = #{shNum, javaType=long, jdbcType=NUMERIC}
  </select>

  <!-- 동일 shNum 존재 여부 -->
  <select id="existsRegistrationByShNum" parameterType="long" resultType="int">
    SELECT COUNT(1)
    FROM REGISTRATION
    WHERE SHNUM = #{shNum, javaType=long, jdbcType=NUMERIC}
  </select>

  <!-- 예약 등록 (REGNUM 시퀀스 채번) -->
  <insert id="insertPtRegistration" parameterType="com.example.gymerp.dto.PtRegistrationDto" useGeneratedKeys="false">
    <selectKey keyProperty="regNum" resultType="long" order="BEFORE">
      SELECT REGISTRATION_SEQ.NEXTVAL FROM DUAL
    </selectKey>

    <![CDATA[
    INSERT INTO REGISTRATION (
      REGNUM, EMPNUM, MEMNUM, SHNUM,
      REGCREATED, REGUPDATEDAT, REGNOTE
    ) VALUES (
      #{regNum, javaType=long, jdbcType=NUMERIC},
      #{empNum, javaType=long, jdbcType=NUMERIC},
      #{memNum, javaType=long, jdbcType=NUMERIC},
      #{shNum,  javaType=long, jdbcType=NUMERIC},
      SYSTIMESTAMP,
      SYSTIMESTAMP,
      #{regNote, jdbcType=VARCHAR}
    )
    ]]>
  </insert>

  <!-- 예약 수정 -->
  <update id="updatePtRegistration" parameterType="com.example.gymerp.dto.PtRegistrationDto">
    UPDATE REGISTRATION
    SET 
      EMPNUM = #{empNum, javaType=long, jdbcType=NUMERIC},
      MEMNUM = #{memNum, javaType=long, jdbcType=NUMERIC},
      SHNUM  = #{shNum,  javaType=long, jdbcType=NUMERIC},
      REGNOTE = #{regNote, jdbcType=VARCHAR},
      REGUPDATEDAT = SYSTIMESTAMP
    WHERE REGNUM = #{regNum, javaType=long, jdbcType=NUMERIC}
  </update>

  <!-- 스케줄 번호로 PT 등록번호 조회 -->
  <select id="findRegNumByShNum" parameterType="long" resultType="long">
    SELECT REGNUM
    FROM REGISTRATION
    WHERE SHNUM = #{shNum, javaType=long, jdbcType=NUMERIC}
  </select>

</mapper>
