<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="PtRegistrationMapper">


  <!-- 전체 예약 목록 조회 -->
    <select id="getAllPtRegistration" resultType="com.example.gymerp.dto.PtRegistrationDto">
        SELECT 
            REGNUM,EMPNUM,MEMNUM,SHNUM,REGCREATED,REGTIME,
            LASTTIME,REGDATE,REGUPDATEDAT,REGNOTE
        FROM REGISTRATION
        ORDER BY REGNUM DESC
    </select>

  <!-- 단일 예약 조회 -->
    <select id="getPtRegistrationById" parameterType="int" resultType="com.example.gymerp.dto.PtRegistrationDto">
       SELECT 
            REGNUM,
            EMPNUM,
            MEMNUM,
            SHNUM,
            REGCREATED,
            REGUPDATEDAT,
            REGNOTE
        FROM REGISTRATION
        WHERE REGNUM = #{regNum}
    </select>
    
	<!-- 일정번호(shNum)로 조회 -->
    <select id="getByShNum" parameterType="int" resultType="com.example.gymerp.dto.PtRegistrationDto">
        SELECT 
            REGNUM, EMPNUM, MEMNUM, SHNUM, REGCREATED,
            REGUPDATEDAT, REGNOTE
        FROM REGISTRATION
        WHERE SHNUM = #{shNum}
    </select>
    
  	<!-- 예약 등록 -->
	<insert id="insertPtRegistration" parameterType="PtRegistrationDto" useGeneratedKeys="false">
	    <selectKey keyProperty="regNum" resultType="long" order="BEFORE">
	        SELECT REGISTRATION_SEQ.NEXTVAL FROM DUAL
	    </selectKey>
	
	    INSERT INTO REGISTRATION (
	        REGNUM, EMPNUM, MEMNUM, SHNUM, REGCREATED, REGUPDATEDAT, REGNOTE
	    )
	    VALUES (
	        #{regNum}, 
	        #{empNum}, 
	        #{memNum}, 
	        #{shNum}, 
	        SYSTIMESTAMP, 
	        SYSTIMESTAMP, 
	        #{regNote}
	    )
	</insert>

  	<!-- 예약 수정 -->
    <update id="updatePtRegistration" parameterType="com.example.gymerp.dto.PtRegistrationDto">
        UPDATE REGISTRATION
        SET 
            EMPNUM = #{empNum},
            MEMNUM = #{memNum},
            SHNUM = #{shNum},
            REGTIME = #{regTime},
            LASTTIME = #{lastTime},
            REGDATE = #{regDate},
            REGNOTE = #{regNote},
            REGUPDATEDAT = SYSTIMESTAMP
        WHERE REGNUM = #{regNum}
    </update>
	
    <!-- 예약 삭제 -->
    <delete id="deletePtRegistration" parameterType="int">
        DELETE FROM REGISTRATION
        WHERE REGNUM = #{regNum}
    </delete>
    
    <!-- 스케줄 번호로 PT 등록번호 조회 -->
    <select id="findRegNumByShNum" parameterType="int" resultType="int">
        SELECT regNum
	    FROM REGISTRATION
	    WHERE shNum = #{shNum}
    </select>
    
    <!-- PT 회차 차감 -->
	<update id="decreaseRemainingCount" parameterType="int">
	    UPDATE MEMBERSHIP
	    SET REMAINING_COUNT = REMAINING_COUNT - 1
	    WHERE MEMNUM = #{memNum}
	</update>
	
	<!-- PT 회차 복원 -->
	<update id="increaseRemainingCount" parameterType="int">
	    UPDATE MEMBERSHIP
	    SET REMAINING_COUNT = REMAINING_COUNT + 1
	    WHERE MEMNUM = #{memNum}
	</update>
	
	
<!-- =========================================== 추가 ================================================== -->
	
	<!-- 조건을 모두 만족할 때만 REGISTRATION INSERT -->
	<insert id="insertRegistrationIfAllowed" parameterType="com.example.gymerp.dto.PtRegistrationDto">
	  <selectKey keyProperty="regNum" resultType="long" order="BEFORE">
	    SELECT REGISTRATION_SEQ.NEXTVAL FROM DUAL
	  </selectKey>
	  INSERT INTO REGISTRATION (
	    REGNUM, EMPNUM, MEMNUM, SHNUM, REGCREATED, REGUPDATEDAT, REGNOTE
	  )
	  SELECT
	    #{regNum}, #{empNum}, #{memNum}, #{shNum}, SYSTIMESTAMP, SYSTIMESTAMP, #{regNote}
	  FROM dual
	  WHERE
	    /* 유효 회원권 존재 */
	    EXISTS (
	      SELECT 1 FROM voucher_log
	      WHERE memNum = #{memNum}
	        AND endDate >= SYSDATE
	    )
	    /* 잔여 PT > 0 */
	    AND (
	      SELECT NVL(SUM(countChange), 0)
	      FROM pt_log
	      WHERE memNum = #{memNum}
	    ) > 0
	    /* shNum 중복 없음 */
	    AND NOT EXISTS (
	      SELECT 1 FROM REGISTRATION
	      WHERE shNum = #{shNum}
	    )
	</insert>

<!-- ============================================================================================= -->
	  <!-- 등록 번호에 대한 회원 번호 갱신 -->
  <update id="updateRegistrationMemNum" parameterType="map">
      UPDATE REGISTRATION
         SET memNum = #{newMemNum}
       WHERE regNum = #{regNum}
  </update>

	
</mapper>