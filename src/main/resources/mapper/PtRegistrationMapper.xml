<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.gymerp.repository.PtRegistrationMapper">

  <!-- ========================================= -->
  <!-- 전체 예약 목록 조회 (JOIN으로 시간까지 조회) -->
  <!-- ========================================= -->
  <select id="getAllPtRegistration" parameterType="map" resultType="com.example.gymerp.dto.PtRegistrationDto">
      SELECT 
          r.REGNUM,
          r.EMPNUM,
          r.MEMNUM,
          r.SHNUM,
          s.STARTTIME AS regTime,
          s.ENDTIME AS lastTime,
          r.REGCREATED,
          r.REGUPDATEDAT,
          r.REGNOTE
      FROM REGISTRATION r
      JOIN SCHEDULE s ON r.SHNUM = s.SHNUM
      <where>
          <if test="empNum != null">
              r.EMPNUM = #{empNum}
          </if>
          <if test="date != null">
              AND TRUNC(s.STARTTIME) = TO_DATE(#{date}, 'YYYY-MM-DD')
          </if>
      </where>
      ORDER BY r.REGNUM DESC
  </select>

  <!-- ========================================= -->
  <!-- 단일 예약 조회 (JOIN으로 시간 포함) -->
  <!-- ========================================= -->
  <select id="getPtRegistrationById" parameterType="int" resultType="com.example.gymerp.dto.PtRegistrationDto">
      SELECT 
          r.REGNUM,
          r.EMPNUM,
          r.MEMNUM,
          r.SHNUM,
          s.STARTTIME AS regTime,
          s.ENDTIME AS lastTime,
          r.REGCREATED,
          r.REGUPDATEDAT,
          r.REGNOTE
      FROM REGISTRATION r
      JOIN SCHEDULE s ON r.SHNUM = s.SHNUM
      WHERE r.REGNUM = #{regNum}
  </select>

  <!-- ========================================= -->
  <!-- 예약 등록 -->
  <!-- ========================================= -->
  <insert id="insertPtRegistration" parameterType="com.example.gymerp.dto.PtRegistrationDto">
      <selectKey keyProperty="regNum" resultType="long" order="BEFORE">
          SELECT REGNUM_SEQ.NEXTVAL FROM DUAL
      </selectKey>
      	INSERT INTO REGISTRATION (
	    REGNUM, EMPNUM, MEMNUM, SHNUM, 
	    REGCREATED, REGUPDATEDAT, REGNOTE
		)
		VALUES (
		    #{regNum},
		    #{empNum},
		    #{memNum},
		    #{shNum},
		    SYSTIMESTAMP,
		    SYSTIMESTAMP,
		    #{regNote}
		)
  </insert>

  <!-- ========================================= -->
  <!-- 예약 수정 -->
  <!-- ========================================= -->
  <update id="updatePtRegistration" parameterType="com.example.gymerp.dto.PtRegistrationDto">
      UPDATE REGISTRATION
      SET 
          EMPNUM = #{empNum},
          MEMNUM = #{memNum},
          SHNUM = #{shNum},
          REGNOTE = #{regNote},
          REGUPDATEDAT = SYSTIMESTAMP
      WHERE REGNUM = #{regNum}
  </update>

  <!-- ========================================= -->
  <!-- 예약 삭제 -->
  <!-- ========================================= -->
  <delete id="deletePtRegistration" parameterType="int">
      DELETE FROM REGISTRATION
      WHERE REGNUM = #{regNum}
  </delete>

</mapper>
