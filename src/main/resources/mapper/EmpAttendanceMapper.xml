<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="EmpAttendanceMapper">

	<!-- ========================================================= 공통: 근태 + 
		직원명 조인 (empName) DTO에 empName 필드가 없으면 추가 권장 (String empName) 필드가 없어도 MyBatis는 
		추가 컬럼을 무시하므로 동작엔 문제 없음 ========================================================== -->

	<!-- ✅ 하루치(전직원) + 직원명 JOIN -->
<select id="selectAllByDate" parameterType="date"
		resultType="com.example.gymerp.dto.EmpAttendanceDto">
		SELECT
		a.attNum,
		a.empNum,
		e.empName, -- ✅ 직원명 포함
		a.attDate,
		a.checkIn,
		a.checkOut,
		a.workHours,
		a.attState
		FROM attendance a
		JOIN employee e ON e.empNum = a.empNum
		WHERE TRUNC(a.attDate) = TRUNC(#{date})
		ORDER BY
		e.empName ASC,
		NVL(CAST(a.checkIn AS DATE), a.attDate) ASC,
		a.attNum ASC
	</select>


	<!-- 단건 -->
	<select id="selectEmpAttendanceById" parameterType="int"
		resultType="com.example.gymerp.dto.EmpAttendanceDto">
		SELECT a.attNum, a.empNum, a.attDate, a.checkIn, a.checkOut, a.workHours,
		a.attState,
		e.empName AS empName
		FROM attendance a
		JOIN employee e ON e.empNum = a.empNum
		WHERE a.attNum = #{value}
	</select>

	<!-- 직원별 목록 -->
	<select id="selectEmpAttendancesByEmpNum" parameterType="int"
		resultType="com.example.gymerp.dto.EmpAttendanceDto">
		SELECT a.attNum, a.empNum, a.attDate, a.checkIn, a.checkOut, a.workHours,
		a.attState,
		e.empName AS empName
		FROM attendance a
		JOIN employee e ON e.empNum = a.empNum
		WHERE a.empNum = #{value}
		ORDER BY a.attDate DESC, a.attNum DESC
	</select>

	 <!-- 출근(등록) : DB 현재시각을 KST로 고정 -->
  <insert id="insertEmpAttendance"
          parameterType="com.example.gymerp.dto.EmpAttendanceDto">
    <selectKey keyProperty="attNum" resultType="int" order="BEFORE">
      SELECT ATTENDANCE_SEQ.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO attendance
      (attNum, empNum, attDate, checkIn, checkOut, workHours, attState)
    VALUES
      (
        #{attNum},
        #{empNum},
        /* ✅ 날짜 칼럼은 KST 기준으로 TRUNC */
        NVL(
          #{attDate,jdbcType=DATE},
          TRUNC(CAST((SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul') AS DATE))
        ),
        /* ✅ 체크인 타임스탬프도 KST 고정 */
        NVL(
          #{checkIn,jdbcType=TIMESTAMP},
          CAST((SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul') AS TIMESTAMP)
        ),
        #{checkOut,jdbcType=TIMESTAMP},
        NVL(#{workHours,jdbcType=NUMERIC}, 0),
        NVL(#{attState,jdbcType=VARCHAR}, 'WORKING')
      )
  </insert>

	<!-- 퇴근(체크아웃) : 파라미터 없으면 KST 현재시각 사용, 근무시간 계산도 동일 기준 -->
  <update id="updateEmpAttendanceCheckOut" parameterType="map">
    UPDATE attendance
       SET checkOut = NVL(
                         #{checkOut,jdbcType=TIMESTAMP},
                         CAST((SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul') AS TIMESTAMP)  /* ✅ */
                       ),
           workHours =
             CASE
               WHEN checkIn IS NOT NULL THEN
                 /* ✅ (checkOut_KST or now_KST) - checkIn 를 초(second)로 */
                 FLOOR(
                   (
                     CAST(
                       NVL(#{checkOut,jdbcType=TIMESTAMP},
                           CAST((SYSTIMESTAMP AT TIME ZONE 'Asia/Seoul') AS TIMESTAMP)
                       ) AS DATE
                     )
                     - CAST(checkIn AS DATE)
                   ) * 86400
                 )
               ELSE workHours
             END,
           attState = 'DONE'
     WHERE attNum = #{attNum}
  </update>
	<!-- 전체 수정 -->
	<!-- 전체 수정(수동 수정 시에는 전달값을 그대로 저장) -->
  <update id="updateEmpAttendance"
          parameterType="com.example.gymerp.dto.EmpAttendanceDto">
    UPDATE attendance
       SET empNum   = #{empNum},
           attDate  = #{attDate,jdbcType=DATE},
           checkIn  = #{checkIn,jdbcType=TIMESTAMP},
           checkOut = #{checkOut,jdbcType=TIMESTAMP},
           workHours= #{workHours},
           attState = #{attState}
     WHERE attNum   = #{attNum}
  </update>

	<!-- 삭제 -->
	<delete id="deleteEmpAttendance" parameterType="int">
		DELETE FROM attendance
		WHERE attNum = #{value}
	</delete>

	<!-- 직원별 기간 조회 -->
	<select id="selectEmpAttendancesByRange" parameterType="map"
		resultType="com.example.gymerp.dto.EmpAttendanceDto">
		SELECT a.attNum, a.empNum, a.attDate, a.checkIn, a.checkOut, a.workHours,
		a.attState,
		e.empName AS empName
		FROM attendance a
		JOIN employee e ON e.empNum = a.empNum
		WHERE a.empNum = #{empNum}
		AND a.attDate BETWEEN #{from} AND #{to}
		ORDER BY a.attDate DESC, a.attNum DESC
	</select>

	<!-- (옵션) 전직원 기간 조회 필요 시 사용 -->
	<select id="selectAllByRange" parameterType="map"
		resultType="com.example.gymerp.dto.EmpAttendanceDto">
		SELECT a.attNum, a.empNum, a.attDate, a.checkIn, a.checkOut, a.workHours,
		a.attState,
		e.empName AS empName
		FROM attendance a
		JOIN employee e ON e.empNum = a.empNum
		WHERE a.attDate BETWEEN #{from} AND #{to}
		ORDER BY e.empName ASC, a.attDate DESC, a.attNum DESC
	</select>

	<!-- 전체 목록 (전직원, 최신순) -->
	<select id="selectAllEmpAttendances"
		resultType="com.example.gymerp.dto.EmpAttendanceDto">
		SELECT
		a.attNum,
		a.empNum,
		e.empName,
		a.attDate,
		a.checkIn,
		a.checkOut,
		a.workHours,
		a.attState
		FROM attendance a
		JOIN employee e ON e.empNum = a.empNum
		ORDER BY a.attDate DESC, a.attNum DESC
	</select>
</mapper>
