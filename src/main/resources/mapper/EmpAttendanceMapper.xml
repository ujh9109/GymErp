<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="EmpAttendance.mapper"> <!-- ✅ 네임스페이스 통일 -->

  <!-- 전체 목록 -->
  <select id="selectAllEmpAttendances"
          resultType="com.example.gymerp.dto.EmpAttendanceDto">
    SELECT attNum, empNum, attDate, checkIn, checkOut, workHours, attState
    FROM attendance
    ORDER BY attNum DESC
  </select>

  <!-- 단건 조회 (단일 파라미터 int → #{value}) -->
  <select id="selectEmpAttendanceById"
          parameterType="int"
          resultType="com.example.gymerp.dto.EmpAttendanceDto">
    SELECT attNum, empNum, attDate, checkIn, checkOut, workHours, attState
    FROM attendance
    WHERE attNum = #{value}
  </select>

  <!-- 직원별 목록 (단일 파라미터 int → #{value}) -->
  <select id="selectEmpAttendancesByEmpNum"
          parameterType="int"
          resultType="com.example.gymerp.dto.EmpAttendanceDto">
    SELECT attNum, empNum, attDate, checkIn, checkOut, workHours, attState
    FROM attendance
    WHERE empNum = #{value}
    ORDER BY attDate DESC, attNum DESC
  </select>

  <!-- 출근(등록) -->
  <insert id="insertEmpAttendance"
          parameterType="com.example.gymerp.dto.EmpAttendanceDto">
    <selectKey keyProperty="attNum" resultType="int" order="BEFORE">
      SELECT ATTENDANCE_SEQ.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO attendance
      (attNum, empNum, attDate, checkIn, checkOut, workHours, attState)
    VALUES
      (#{attNum},
       #{empNum},
       NVL(#{attDate,jdbcType=DATE}, TRUNC(SYSDATE)),
       NVL(#{checkIn,jdbcType=TIMESTAMP}, SYSTIMESTAMP),
       #{checkOut,jdbcType=TIMESTAMP},
       NVL(#{workHours,jdbcType=NUMERIC}, 0),
       NVL(#{attState,jdbcType=VARCHAR}, 'WORKING'))
  </insert>

  <!-- 퇴근(체크아웃) : map(attNum, checkOut) -->
  <update id="updateEmpAttendanceCheckOut" parameterType="map">
    UPDATE attendance
       SET checkOut = NVL(#{checkOut,jdbcType=TIMESTAMP}, SYSTIMESTAMP),
           workHours = CASE
                         WHEN checkIn IS NOT NULL THEN
                           FLOOR(
                             (CAST(NVL(#{checkOut,jdbcType=TIMESTAMP}, SYSTIMESTAMP) AS DATE)
                              - CAST(checkIn AS DATE)) * 86400
                           )
                         ELSE workHours
                       END,
           attState = 'DONE'
     WHERE attNum = #{attNum}
  </update>

  <!-- 전체 수정 -->
  <update id="updateEmpAttendance"
          parameterType="com.example.gymerp.dto.EmpAttendanceDto">
    UPDATE attendance
       SET empNum    = #{empNum},
           attDate   = #{attDate,jdbcType=DATE},
           checkIn   = #{checkIn,jdbcType=TIMESTAMP},
           checkOut  = #{checkOut,jdbcType=TIMESTAMP},
           workHours = #{workHours},
           attState  = #{attState}
     WHERE attNum    = #{attNum}
  </update>

  <!-- 삭제 (단일 파라미터 int → #{value}) -->
  <delete id="deleteEmpAttendance" parameterType="int">
    DELETE FROM attendance
    WHERE attNum = #{value}
  </delete>

  <!-- 기간 조회 : map(empNum, from, to) -->
  <select id="selectEmpAttendancesByRange"
          parameterType="map"
          resultType="com.example.gymerp.dto.EmpAttendanceDto">
    SELECT attNum, empNum, attDate, checkIn, checkOut, workHours, attState
    FROM attendance
    WHERE empNum = #{empNum}
      AND attDate BETWEEN #{from} AND #{to}
    ORDER BY attDate DESC, attNum DESC
  </select>

</mapper>
