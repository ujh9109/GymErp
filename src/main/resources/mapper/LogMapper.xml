<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="LogMapper">

    <!-- ===============================
         [회원권 LOG - 단일 Row 관리]
    =============================== -->

    <!-- 회원권 단건 조회 -->
    <select id="selectVoucherByMember" parameterType="long" resultType="VoucherLogDto">
        SELECT voucherId, memNum, memberName, startDate, endDate
        FROM voucher_log
        WHERE memNum = #{memNum}
    </select>

    <!-- 회원권 유효 여부 확인 -->
    <select id="checkVoucherValid" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM voucher_log
        WHERE memNum = #{memNum}
          AND endDate &gt;= SYSDATE
    </select>

    <!-- 회원권 신규 등록 -->
    <insert id="insertVoucherLog" parameterType="VoucherLogDto">
        <selectKey keyProperty="voucherId" resultType="long" order="BEFORE">
            SELECT voucher_log_seq.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO voucher_log (voucherId, memNum, memberName, startDate, endDate)
        VALUES (#{voucherId}, #{memNum}, #{memberName}, #{startDate}, #{endDate})
    </insert>

    <!-- 회원권 기간 연장 -->
    <update id="extendVoucherLog" parameterType="VoucherLogDto">
        UPDATE voucher_log
        SET endDate = #{endDate}
        WHERE memNum = #{memNum}
    </update>

    <!-- 회원권 만료 후 재시작 -->
    <update id="renewVoucherLog" parameterType="VoucherLogDto">
        UPDATE voucher_log
        SET startDate = SYSDATE,
            endDate = #{endDate}
        WHERE memNum = #{memNum}
    </update>

    <!-- 회원권 부분환불 (endDate 단축) -->
    <update id="partialRefundVoucherLog" parameterType="VoucherLogDto">
        UPDATE voucher_log
        SET endDate = #{endDate}
        WHERE memNum = #{memNum}
    </update>

    <!-- 회원권 전체환불 (이전 상태로 복구) -->
    <update id="rollbackVoucherLog" parameterType="VoucherLogDto">
        UPDATE voucher_log
        SET endDate = #{endDate}
        WHERE memNum = #{memNum}
    </update>

    <!-- ===============================
         [PT LOG - 누적 로그 관리]
    =============================== -->

    <!-- PT 신규 충전 로그 등록 -->
    <insert id="insertPtChargeLog" parameterType="PtLogDto">
        <selectKey keyProperty="usageId" resultType="long" order="BEFORE">
            SELECT pt_log_seq.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO pt_log (
            usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
        ) VALUES (
            #{usageId}, #{memNum}, #{empNum}, '충전', NVL(#{countChange, jdbcType=NUMERIC}, 1), SYSDATE, #{salesId, jdbcType=NUMERIC}, #{regId, jdbcType=NUMERIC}

        )
    </insert>

    <!-- PT 연장 로그 (기존 row 수정) -->
    <update id="updatePtLogExtension" parameterType="PtLogDto">
        UPDATE pt_log
        SET countChange = #{countChange},
            createdAt = SYSDATE
        WHERE usageId = #{usageId}
    </update>

    <!-- PT 부분환불 로그 추가 -->
    <insert id="insertPtPartialRefundLog" parameterType="PtLogDto">
        <selectKey keyProperty="usageId" resultType="long" order="BEFORE">
            SELECT pt_log_seq.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO pt_log (
            usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
        ) VALUES (
            #{usageId}, #{memNum}, #{empNum}, '부분환불', -#{countChange}, SYSDATE, #{salesId}, #{regId}
        )
    </insert>

    <!-- PT 전체환불 로그 추가 -->
    <insert id="insertPtFullRefundLog" parameterType="PtLogDto">
        <selectKey keyProperty="usageId" resultType="long" order="BEFORE">
            SELECT pt_log_seq.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO pt_log (
            usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
        ) VALUES (
            #{usageId}, #{memNum}, #{empNum}, '전체환불', -#{countChange}, SYSDATE, #{salesId}, #{regId}
        )
    </insert>

    <!-- 남은 PT 횟수 조회 -->
    <select id="selectRemainingPtCount" parameterType="long" resultType="int">
        SELECT NVL(SUM(countChange), 0)
        FROM pt_log
        WHERE memNum = #{memNum}
    </select>

    <!-- 특정 환불ID로 PT 로그 조회 -->
    <select id="selectPtLogByUsageId" parameterType="long" resultType="PtLogDto">
        SELECT usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
        FROM pt_log
        WHERE usageId = #{refundId}
    </select>
    
    <!-- =============================== -->
	<!-- [PT 예약 / 취소 관련] -->
	<!-- =============================== -->
	
	<!-- PT 예약 로그 등록 (소비) -->
	<insert id="insertPtConsumeLog" parameterType="PtLogDto">
	    <selectKey keyProperty="usageId" resultType="long" order="BEFORE">
	        SELECT pt_log_seq.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO pt_log (
	        usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
	    ) VALUES (
	        #{usageId}, #{memNum}, #{empNum}, '소비', -1, SYSDATE, NULL, #{regId, jdbcType=NULL}
	    )
	</insert>
	
	<!-- PT 예약 취소 로그 등록 (복구) -->
	<insert id="insertPtCancelLog" parameterType="PtLogDto">
	   <selectKey keyProperty="usageId" resultType="long" order="BEFORE">
        SELECT pt_log_seq.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO pt_log (
        usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
    ) VALUES (
        #{usageId, jdbcType=NUMERIC},
        #{memNum, jdbcType=NUMERIC},
        #{empNum, jdbcType=NUMERIC},
        '예약취소',
        1,
        SYSDATE,
        NULL,
        #{regId, jdbcType=NULL}
    )
	</insert>
	
	<!-- PT 등록번호 기준으로 기존 소비 로그 조회 -->
	<select id="selectPtLogByRegId" parameterType="long" resultType="PtLogDto">
	    SELECT usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
	    FROM pt_log
	    WHERE regId = #{regId}
	      AND status = '소비'
	</select>

</mapper>
