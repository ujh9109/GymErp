<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="LogMapper">

    <!-- ===============================
         [회원권 LOG - 단일 Row 관리]
    =============================== -->

    <!-- 회원권 단건 조회 -->
    <select id="selectVoucherByMember" parameterType="long" resultType="VoucherLogDto">
        SELECT voucherId, memNum, memberName, startDate, endDate
        FROM voucher_log
        WHERE memNum = #{memNum}
    </select>

    <!-- 회원권 유효 여부 확인 -->
    <select id="checkVoucherValid" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM voucher_log
        WHERE memNum = #{memNum}
          AND endDate >= SYSDATE
    </select>

    <!-- 회원권 신규 등록 -->
    <insert id="insertVoucherLog" parameterType="VoucherLogDto">
        <selectKey keyProperty="voucherId" resultType="long" order="BEFORE">
            SELECT voucher_log_seq.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO voucher_log (voucherId, memNum, memberName, startDate, endDate)
	    VALUES (
	        #{voucherId},
	        #{memNum},
	        #{memberName},
	        TO_DATE(SUBSTR(#{startDate}, 1, 19), 'YYYY-MM-DD"T"HH24:MI:SS'),
	        TO_DATE(SUBSTR(#{endDate}, 1, 19), 'YYYY-MM-DD"T"HH24:MI:SS')
	    )
    </insert>

    <!-- 회원권 기간 연장 -->
    <update id="extendVoucherLog" parameterType="VoucherLogDto">
        UPDATE voucher_log
        SET endDate = #{endDate}
        WHERE memNum = #{memNum}
    </update>

    <!-- 회원권 만료 후 재시작 -->
    <update id="renewVoucherLog" parameterType="VoucherLogDto">
        UPDATE voucher_log
        SET startDate = SYSDATE,
            endDate = #{endDate}
        WHERE memNum = #{memNum}
    </update>

    <!-- 회원권 부분환불 (endDate 단축) -->
    <update id="partialRefundVoucherLog" parameterType="VoucherLogDto">
	    UPDATE voucher_log
	    SET endDate = TO_DATE(#{endDate}, 'YYYY-MM-DD HH24:MI:SS')
	    WHERE memNum = #{memNum}
	</update>

    <!-- 회원권 전체환불 (미사용 상태에서 endDate 단축) -->
    <update id="fullRefundVoucherLog" parameterType="VoucherLogDto">
        UPDATE voucher_log
        SET endDate = TO_DATE(#{endDate}, 'YYYY-MM-DD HH24:MI:SS')
        WHERE memNum = #{memNum}
    </update>

    <!-- 회원권 연장 일수 추가 -->
    <update id="extendVoucherPeriod" parameterType="map">
        UPDATE voucher_log
           SET endDate = endDate + #{extendDays}
         WHERE memNum = #{memNum}
    </update>



    <!-- ===============================
         [PT LOG - 누적 로그 관리]
    =============================== -->

    <!-- PT 신규 충전 로그 등록 -->
    <insert id="insertPtChargeLog" parameterType="PtLogDto">
        <selectKey keyProperty="usageId" resultType="long" order="BEFORE">
            SELECT pt_log_seq.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO pt_log (
            usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
        ) VALUES (
            #{usageId}, #{memNum}, #{empNum}, '충전',  #{countChange, jdbcType=NUMERIC}, SYSDATE, #{salesId, jdbcType=NUMERIC}, #{regId, jdbcType=NUMERIC}
        )
    </insert>

    <!-- PT 부분환불 로그 등록 -->
    <insert id="insertPtPartialRefundLog" parameterType="PtLogDto">
        <selectKey keyProperty="usageId" resultType="long" order="BEFORE">
            SELECT pt_log_seq.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO pt_log (
            usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
        ) VALUES (
            #{usageId}, #{memNum}, #{empNum}, '부분환불', #{countChange}, SYSDATE, #{salesId}, #{regId, jdbcType=NUMERIC}
        )
    </insert>

    <!-- PT 전체환불 로그 등록 -->
    <insert id="insertPtFullRefundLog" parameterType="PtLogDto">
        <selectKey keyProperty="usageId" resultType="long" order="BEFORE">
            SELECT pt_log_seq.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO pt_log (
            usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
        ) VALUES (
            #{usageId}, #{memNum}, #{empNum}, '전체환불', #{countChange}, SYSDATE, #{salesId}, #{regId, jdbcType=NUMERIC}
        )
    </insert>

    <!-- 기존 충전 로그 조회 -->
    <select id="getPtLogBySalesId" parameterType="long" resultType="PtLogDto">
        SELECT usageId, memNum, empNum, status, countChange, salesId, createdAt
        FROM pt_log
        WHERE salesId = #{salesId}
          AND status = '충전'
    </select>

    <!-- PT 연장 시 기존 충전 로그 수정 -->
    <update id="updatePtChargeCount" parameterType="PtLogDto">
        UPDATE pt_log
           SET countChange = #{countChange}
         WHERE salesId = #{salesId}
           AND status = '충전'
    </update>

    <!-- 남은 PT 횟수 계산 -->
    <select id="selectRemainingPtCount" parameterType="long" resultType="int">
        SELECT NVL(SUM(countChange), 0)
        FROM pt_log
        WHERE memNum = #{memNum}
    </select>

    <!-- 환불ID 기준 PT 로그 조회 -->
    <select id="selectPtLogByUsageId" parameterType="long" resultType="PtLogDto">
        SELECT usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
        FROM pt_log
        WHERE usageId = #{refundId}
    </select>

    <!-- 내 차례 도달 여부 판별 -->
    <select id="checkPtTurnReached" parameterType="map" resultType="int">
        SELECT CASE
                 WHEN NVL(SUM(CASE WHEN status = '소비' THEN -countChange ELSE 0 END), 0)
                      >= NVL(SUM(CASE WHEN status = '충전' AND salesId &lt; #{salesId} THEN countChange ELSE 0 END), 0)
                 THEN 1
                 ELSE 0
               END AS turnReached
        FROM pt_log
        WHERE memNum = #{memNum}
    </select>



    <!-- ===============================
         [PT 예약 / 취소 관련]
    =============================== -->

    <!-- PT 예약 로그 등록 (소비) -->
    <insert id="insertPtConsumeLog" parameterType="PtLogDto">
        <selectKey keyProperty="usageId" resultType="long" order="BEFORE">
            SELECT pt_log_seq.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO pt_log (
            usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
        )
        SELECT
            #{usageId}, #{memNum}, #{empNum}, '소비', -1, SYSDATE, NULL, #{regId, jdbcType=NULL}
        FROM dual
        WHERE (
            SELECT NVL(SUM(countChange), 0)
            FROM pt_log
            WHERE memNum = #{memNum}
        ) > 0
    </insert>

    <!-- PT 예약 취소 로그 등록 (복구) -->
    <insert id="insertPtCancelLog" parameterType="PtLogDto">
        <selectKey keyProperty="usageId" resultType="long" order="BEFORE">
            SELECT pt_log_seq.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO pt_log (
            usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
        ) VALUES (
            #{usageId, jdbcType=NUMERIC},
            #{memNum, jdbcType=NUMERIC},
            #{empNum, jdbcType=NUMERIC},
            '예약취소',
            1,
            SYSDATE,
            NULL,
            #{regId, jdbcType=NULL}
        )
    </insert>

    <!-- 등록번호 기준 소비 로그 조회 -->
    <select id="selectPtLogByRegId" parameterType="long" resultType="PtLogDto">
        SELECT usageId, memNum, empNum, status, countChange, createdAt, salesId, regId
        FROM pt_log
        WHERE regId = #{regId}
          AND status = '소비'
    </select>

    <!-- 차례 이후 실제 사용 여부 확인 -->
    <select id="getUsedCountBySalesId" parameterType="long" resultType="int">
	    SELECT NVL(SUM(
	        CASE
	            WHEN status IN ('소비', '부분환불', '전체환불') THEN countChange
	            WHEN status = '예약취소' THEN -countChange
	            ELSE 0
	        END
	    ), 0)
	    FROM pt_log
	    WHERE salesId = #{salesId}
	</select>

</mapper>
